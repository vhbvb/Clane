<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.10 (454267)"/><meta name="altitude" content="16.79165077209473"/><meta name="author" content="冯鸿杰"/><meta name="created" content="2016-12-29 08:12:42 +0000"/><meta name="latitude" content="31.1753464042296"/><meta name="longitude" content="121.4090234115959"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-03-24 03:13:34 +0000"/><title>使用Xcode开发iOS语法检查的Clang插件</title></head><body><div><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">1. 前言
</h1><div><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Xcode编译依赖于Clang编译器，由于clang是LLVM的一部分，而LLVM（构架编译器(compiler)的框架系统，以C++编写而成，用于优化以任意程序语言编写的程序的编译时间(compile-time)、链接时间(link-time)、运行时间(run-time)以及空闲时间(idle-time)，对开发者保持开放，并兼容已有脚本）又是一个开源的项目，因此，使得Clang可定制成为了可能。而且Clang本来也支持插件，那么也说明了Xcode也支持这样的插件。所以下面的文章重点讲述如何在Xcode中实现Clang插件的编写。
</p><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">2. 获取Clang源码
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">由于是要使用到Xcode中，因此最好还是从苹果官网中<a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="https://opensource.apple.com/tarballs/clang/clang-800.0.42.1.tar.gz">获取LLVM的源码</a>，目前版本是Xcode8.1下的LLVM的源码，<strong style="box-sizing: border-box; font-weight: 700;">注意苹果的命名是clang-800.0.42.1，不要以为只是Clang部分的源码，一开始我就是被这样坑的</strong>。其中LLVM主要的子项目包括：
</p><table style="box-sizing: border-box; border-collapse: collapse; border-spacing: 0px; background-color: rgb(255, 255, 255); border-top: 1px solid rgb(221, 221, 221); border-right: 1px solid rgb(221, 221, 221); border-bottom: 1px solid rgb(221, 221, 221); border-image: initial; border-left: none; word-break: normal; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">
<thead style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><th style="box-sizing: border-box; padding: 8px; text-align: inherit; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle; font-weight: 700;">名称</th><th style="box-sizing: border-box; padding: 8px; text-align: inherit; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle; font-weight: 700;">描述</th>
</tr></thead><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">LLVM Core </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">包含一个现在的源代码/目标设备无关的优化器，一集一个针对很多主流(甚至于一些非主流)的CPU的汇编代码生成支持。包含一个现在的源代码/目标设备无关的优化器，一集一个针对很多主流(甚至于一些非主流)的CPU的汇编代码生成支持。 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">Clang </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">一个C/C++/Objective-C编译器，致力于提供令人惊讶的快速编译，极其有用的错误和警告信息，提供一个可用于构建很棒的源代码级别的工具. </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">dragonegg </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">gcc插件，可将GCC的优化和代码生成器替换为LLVM的相应工具。 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">LLDB </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">基于LLVM提供的库和Clang构建的优秀的本地调试器。 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">libc++、libc++ ABI </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">符合标准的，高性能的C++标准库实现，以及对C++11的完整支持。 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">compiler-rt </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">针对"__fixunsdfdi"和其他目标机器上没有一个核心IR(intermediate representation)对应的短原生指令序列时，提供高度调优过的底层代码生成支持。 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">OpenMP </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">Clang中对多平台并行编程的runtime支持。 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">vmkit </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">基于LLVM的Java和.NET虚拟机实现 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">polly </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">支持高级别的循环和数据本地化优化支持的LLVM框架。 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">libclc </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">OpenCL(开放运算语言)标准库的实现 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">klee </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">基于LLVM编译基础设施的符号化虚拟机 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">SAFECode </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">内存安全的C/C++编译器 </td>
</tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">lld </td><td style="box-sizing: border-box; padding: 8px; border-left: 1px solid rgb(221, 221, 221); border-top: 1px solid rgb(221, 221, 221); vertical-align: middle;">clang/llvm内置的链接器 </td>
</tr></tbody></table><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">本文主要针对Clang项目进行讲述，要先使用Clang必须先对LLVM进行编译。
</p><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">3. 编译LLVM
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">下载源码完成后解压目录，接下来就是要做编译LLVM的工作了。首先来对这些源码生成一个Xcode工程，源码项目的编译是由cmake管理（关于cmake详细资料请参考：<a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="https://cmake.org/cmake-tutorial/">cmake官方教程</a>），因此生成Xcode工程非常方便。执行下面的shell命令：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">cd 解压llvm目录
mkdir build &amp;&amp; cd build
cmake -G Xcode <span style="box-sizing: border-box;">-DCMAKE_BUILD_TYPE=Release</span> -DCMAKE_OSX_ARCHITECTURES:<span style="box-sizing: border-box;">STRING=x86_64</span> <span style="box-sizing: border-box;">-DLLVM_TARGETS_TO_BUILD=host</span> <span style="box-sizing: border-box;">-DLLVM_INCLUDE_TESTS=OFF</span> <span style="box-sizing: border-box;">-DCLANG_INCLUDE_TESTS=OFF</span> <span style="box-sizing: border-box;">-DLLVM_INCLUDE_UTILS=OFF</span> <span style="box-sizing: border-box;">-DLLVM_INCLUDE_DOCS=OFF</span> <span style="box-sizing: border-box;">-DLLVM_INCLUDE_EXAMPLES=OFF</span> <span style="box-sizing: border-box;">-DLLVM_BUILD_EXTERNAL_COMPILER_RT=ON</span> <span style="box-sizing: border-box;">-DLIBCXX_INCLUDE_TESTS=OFF</span> <span style="box-sizing: border-box;">-DCOMPILER_RT_INCLUDE_TESTS=OFF</span> <span style="box-sizing: border-box;">-DCOMPILER_RT_ENABLE_IOS=OFF</span> ../src</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">等待执行，提示成功后即可看到目录下多了一个build目录，点进去就可以看到一个Xcode的工程文件。双击打开项目，然后执行All_BUILD的scheme等待完成即可（这里面会有一个<a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="http://compiler-rt.llvm.org/index.html">compiler_rt</a>的编译报错，表示无法编译compiler_rt，由于这块不涉及插件编写所以可以暂时忽略）。
</p><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">4. 添加一个简单的插件项目
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">找到src/tools/clang/example/目录，在里面新建一个目录如MyPlugin。然后修改example目录的CMakeLists.txt文件，添加一项：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">add_subdirectory</span><span style="box-sizing: border-box;">(MyPlugin)</span></span></code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">然后进入创建的MyPlugin目录，生成三个文件，分别是：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">CMakeList<span style="box-sizing: border-box;">.txt</span>
MyPlugin<span style="box-sizing: border-box;">.cpp</span>
MyPlugin.exports</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">然后在新建的CMakeList.txt中加入下面内容：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"># <span style="box-sizing: border-box; color: rgb(181, 137, 0);">If</span> we don't need <span style="box-sizing: border-box; color: rgb(181, 137, 0);">RTTI</span> or <span style="box-sizing: border-box; color: rgb(181, 137, 0);">EH</span>, there's no reason to ex<span style="box-sizing: border-box; color: rgb(133, 153, 0);">port</span> anything
# from the plugin.
if( <span style="box-sizing: border-box; color: rgb(181, 137, 0);">NOT</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">MSVC</span> ) # MSVC mangles symbols differently
  if( <span style="box-sizing: border-box; color: rgb(181, 137, 0);">NOT</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">LLVM_REQUIRES_RTTI</span> )
    if( <span style="box-sizing: border-box; color: rgb(181, 137, 0);">NOT</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">LLVM_REQUIRES_EH</span> )
      set(<span style="box-sizing: border-box; color: rgb(181, 137, 0);">LLVM_EXPORTED_SYMBOL_FILE</span> ${<span style="box-sizing: border-box; color: rgb(181, 137, 0);">CMAKE_CURRENT_SOURCE_DIR</span>}/<span style="box-sizing: border-box; color: rgb(181, 137, 0);">MyPlugins</span>.exports)
    endif()
  endif()
endif()

add_llvm_loadable_module(<span style="box-sizing: border-box; color: rgb(181, 137, 0);">MyPlugin</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">MyPlugin</span>.cpp)

if(<span style="box-sizing: border-box; color: rgb(181, 137, 0);">LLVM_ENABLE_PLUGINS</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">AND</span> (<span style="box-sizing: border-box; color: rgb(181, 137, 0);">WIN32</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">OR</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">CYGWIN</span>))
  target_link_libraries(<span style="box-sizing: border-box; color: rgb(181, 137, 0);">MyPlugin</span> ${cmake_2_8_12_PRIVATE}
    clangAST
    clangBasic
    clangFrontend
    <span style="box-sizing: border-box; color: rgb(181, 137, 0);">LLVMSupport</span>
    )
endif()</code></pre><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5. 开发插件
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">然后在插件文件MyPlugin.cpp中，添加下面的内容：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(147, 161, 161);">#include "clang/Frontend/FrontendPluginRegistry.h"</span>
<span style="box-sizing: border-box; color: rgb(147, 161, 161);">#include "clang/AST/AST.h"</span>
<span style="box-sizing: border-box; color: rgb(147, 161, 161);">#include "clang/AST/ASTConsumer.h"</span>
<span style="box-sizing: border-box; color: rgb(147, 161, 161);">#include "clang/Frontend/CompilerInstance.h"</span>

using namespace clang;

namespace
{
    class MyPluginConsumer : public ASTConsumer
    {
    CompilerInstance &amp;Instance;
    <span style="box-sizing: border-box; color: rgb(203, 75, 22);">std:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:set&lt;std</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:string&gt;</span> ParsedTemplates;
    <span style="box-sizing: border-box; color: rgb(203, 75, 22);">public:</span>
        MyPluginConsumer(CompilerInstance &amp;Instance,
                               <span style="box-sizing: border-box; color: rgb(203, 75, 22);">std:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:set&lt;std</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:string&gt;</span> ParsedTemplates)
        : Instance(Instance), ParsedTemplates(ParsedTemplates) {}
    };

    class MyPluginASTAction : public PluginASTAction
    {
    <span style="box-sizing: border-box; color: rgb(203, 75, 22);">std:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:set&lt;std</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:string&gt;</span> ParsedTemplates;
    <span style="box-sizing: border-box; color: rgb(203, 75, 22);">protected:</span>
        <span style="box-sizing: border-box; color: rgb(203, 75, 22);">std:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:unique_ptr&lt;ASTConsumer&gt;</span> CreateASTConsumer(CompilerInstance &amp;CI,
                                                       <span style="box-sizing: border-box; color: rgb(203, 75, 22);">llvm:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:StringRef</span>) override
        {
            <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box; color: rgb(203, 75, 22);">llvm:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:make_unique&lt;MobCodeConsumer&gt;</span>(CI, ParsedTemplates);
        }

        bool ParseArgs(const CompilerInstance &amp;CI,
                       const <span style="box-sizing: border-box; color: rgb(203, 75, 22);">std:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:vector&lt;std</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:string&gt;</span> &amp;args) override {

            DiagnosticsEngine &amp;D = CI.getDiagnostics();
            D.Report(D.getCustomDiagID(<span style="box-sizing: border-box; color: rgb(203, 75, 22);">DiagnosticsEngine:</span><span style="box-sizing: border-box; color: rgb(203, 75, 22);">:Error</span>,
                                       “My plugin Started...<span style="box-sizing: border-box; color: rgb(42, 161, 152);">"));

            return true;
        }
    };
}

static clang::FrontendPluginRegistry::Add&lt;MyPluginASTAction&gt;
X("</span>MyPlugin<span style="box-sizing: border-box; color: rgb(42, 161, 152);">", “My plugin"</span>);</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">上面的代码中主要先看看<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">MyPluginASTAction</code>的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">ParseArgs</code>方法，这是一个插件的入口函数，在这个方法里面调用了一个叫<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">DiagnosticsEngine</code>对象的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">Report</code>方法，这段代码的主要功能是向编译器报告一个错误，而错误的描述就是“My plugin Started...”，下面会有具体的演示效果。关于其它部分的代码现在可以暂时不用理会，后续的章节会进行详细的说明。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">现在先回到源码根目录，使用同样的cmake语句来更新Xcode项目，更新完成后原来的项目会多出一个叫MyPlugin的插件项目，然后对这个插件项目进行编译。编译成功后会在Debug/lib目录中多出一个叫MyPlugin.dylib文件。
</p><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">6. 配置调用插件的Xcode项目
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">打开要使用插件的Xcode项目，在build settings一栏中对Other C Flags一项进行编辑，调整为：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">-Xclang -load -Xclang /llvm/build/Debug/<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">lib</span>/<span style="box-sizing: border-box; color: rgb(181, 137, 0);">MyPlugin</span>.<span style="box-sizing: border-box; color: rgb(181, 137, 0);">dylib</span> -<span style="box-sizing: border-box; color: rgb(181, 137, 0);">Xclang</span> -<span style="box-sizing: border-box; color: rgb(181, 137, 0);">add</span>-<span style="box-sizing: border-box; color: rgb(181, 137, 0);">plugin</span> -<span style="box-sizing: border-box; color: rgb(181, 137, 0);">Xclang</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">MyPlugin</span></span></code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><strong style="box-sizing: border-box; font-weight: 700;">注：最后一项-Xclang MyPlugin中的MyPlugin为插件名字，一定要是自己设置的插件名称，否则无法调用插件</strong>。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">由于Clang插件需要对应的Clang版本来加载，如果版本不一致会导致编译错误，如下图所示：
</p><div style="box-sizing: border-box; padding-bottom: 25px; text-align: center; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="%E4%BD%BF%E7%94%A8Xcode%E5%BC%80%E5%8F%91iOS%E8%AF%AD%E6%B3%95%E6%A3%80%E6%9F%A5%E7%9A%84Clang%E6%8F%92%E4%BB%B6.resources/B95FCE12-7238-4E6C-AB46-18A30414F277.png" height="151" width="1240"/><br style="box-sizing: border-box;"/><br/><div style="box-sizing: border-box; min-width: 20%; max-width: 80%; min-height: 22px; padding: 10px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150);">不一致的Clang版本错误
</div></div><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">为了解决这个问题需要调整Xcode中使用的Clang编译器，将默认的编译器改为我们自己编译出来的编译器。具体的方法是在build settings中再添加两项自定义项：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">CC = /clang<span style="box-sizing: border-box; color: rgb(42, 161, 152);">-800.0</span><span style="box-sizing: border-box; color: rgb(42, 161, 152);">.42</span><span style="box-sizing: border-box; color: rgb(42, 161, 152);">.1</span>/build/Debug/bin/clang
CXX =/clang<span style="box-sizing: border-box; color: rgb(42, 161, 152);">-800.0</span><span style="box-sizing: border-box; color: rgb(42, 161, 152);">.42</span><span style="box-sizing: border-box; color: rgb(42, 161, 152);">.1</span>/build/Debug/bin/clang++</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">目的用于指定Xcode的编译器从之前默认的，改为自定义的Clang编译器（<strong style="box-sizing: border-box; font-weight: 700;">注：CC和CXX中需要指定为你编译出来的Clang所在的绝对路径</strong>）。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Common + B 编译则可以看到一个插件输出的错误提示。
</p><div style="box-sizing: border-box; padding-bottom: 25px; text-align: center; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="%E4%BD%BF%E7%94%A8Xcode%E5%BC%80%E5%8F%91iOS%E8%AF%AD%E6%B3%95%E6%A3%80%E6%9F%A5%E7%9A%84Clang%E6%8F%92%E4%BB%B6.resources/9F9200F3-BB42-4FED-AAD4-91A3B243EAD0.png" height="104" width="474"/><br style="box-sizing: border-box;"/><br/><div style="box-sizing: border-box; min-width: 20%; max-width: 80%; min-height: 22px; padding: 10px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150);">插件输出错误
</div></div><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">7. 抽象语法树AST
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在实现语法检测之前，需要了解一个叫AST（抽象语法树）的东西（以下内容选自<a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="http://blog.chinaunix.net/uid-26750235-id-3139100.html">http://blog.chinaunix.net/uid-26750235-id-3139100.html</a>）：
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">抽象语法树（abstract syntax code，AST）是源代码的抽象语法结构的树状表示，树上的每个节点都表示源代码中的一种结构，之所以说是抽象的，是因为抽象语法树并不会表示出真实语法出现的每一个细节，比如说，嵌套括号被隐含在树的结构中，并没有以节点的形式呈现。抽象语法树并不依赖于源语言的语法，也就是说语法分析阶段所采用的上下文无关文法，因为在写文法时，经常会对文法进行等价的转换（消除左递归，回溯，二义性等），这样会给文法分析引入一些多余的成分，对后续阶段造成不利影响，甚至会使合个阶段变得混乱。因些，很多编译器经常要独立地构造语法分析树，为前端，后端建立一个清晰的接口。基于AST的不依赖具体文法和不依赖语言细节的特点，使得其在很多领域有广泛的应用，比如浏览器，智能编辑器，编译器。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">来看一个程序转换的语法树实例，来帮助加深对AST的理解：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">while <span style="box-sizing: border-box;">b</span> != <span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>
{
     <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> <span style="box-sizing: border-box;">a</span> &gt; <span style="box-sizing: border-box;">b</span>
         <span style="box-sizing: border-box;">a</span> = a-<span style="box-sizing: border-box;">b</span>
     <span style="box-sizing: border-box; color: rgb(133, 153, 0);">else</span>
         <span style="box-sizing: border-box;">b</span> = b-<span style="box-sizing: border-box;">a</span>
}

return a</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">上面的一个while循环，经过Clang分析所产生的AST如下图所示：
</p><div style="box-sizing: border-box; padding-bottom: 25px; text-align: center; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="%E4%BD%BF%E7%94%A8Xcode%E5%BC%80%E5%8F%91iOS%E8%AF%AD%E6%B3%95%E6%A3%80%E6%9F%A5%E7%9A%84Clang%E6%8F%92%E4%BB%B6.resources/1D6F24A1-86EB-4853-B755-70F2DFE12446.png" height="674" width="728"/><br style="box-sizing: border-box;"/><br/><div style="box-sizing: border-box; min-width: 20%; max-width: 80%; min-height: 22px; padding: 10px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150);">抽象语法树
</div></div><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">通过上面的语法树可以看到其描述代码的具体结构，而在Clang对代码编译时会进入一个语法树的解析阶段，则这个阶段中语法树的每个节点都会被遍历到，因此借助此阶段可以检测程序中所有代码的书写格式是否符合规范，甚至是对代码编写的质量作出分析。
</p><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">8. 实现编译时语法检测
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">回到上面所说的插件例子中的代码，先来了解一下<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::PluginASTAction</code>和<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::ASTConsumer</code>这两个类。<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::PluginASTAction</code>是一个基于consumer的AST前端Action抽象基类。<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::ASTConsumer</code>则是用于客户读取AST的抽象基类。它们之间的关系是<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::PluginASTAction</code>作为一个关于AST的插件，同时也是访问<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::ASTConsumer</code>的入口；而<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::ASTConsumer</code>则是用于定义如何取得AST相关内容。正如上面所说的，定义继承于<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::PluginASTAction</code>和<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">clang::ASTConsumer</code>类的子类后，通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">static clang::FrontendPluginRegistry::Add&lt;MyPluginASTAction&gt; X("MyPlugin", “My plugin”);</code>就可以把插件注册到Clang中。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">但是上面的例子是不完整的，因为是作为演示，所以在一开始执行时就让编译器报告错误了，并没有进行语法上面的检测。那么，接下来要对例子进行一番改造，让Clang在编译时执行一些编码格式与规范的检测。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">首先，先把<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">MyPluginASTAction</code>类的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">ParseArgs</code>方法中的错误报告去掉，这样可以让编译工作能够继续进行下去。修改后如下：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">class</span> MyPluginASTAction : <span style="box-sizing: border-box; color: rgb(133, 153, 0);">public</span> PluginASTAction
{
    <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">set</span>&lt;<span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>&gt; ParsedTemplates;
    <span style="box-sizing: border-box; color: rgb(133, 153, 0);">protected</span>:
        <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">unique_ptr</span>&lt;ASTConsumer&gt; CreateASTConsumer(CompilerInstance &amp;CI,
                                                       llvm::StringRef) override
        {
            <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> llvm::make_unique&lt;MobCodeConsumer&gt;(CI, ParsedTemplates);
        }

        <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">bool</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">ParseArgs</span><span style="box-sizing: border-box;">(<span style="box-sizing: border-box; color: rgb(133, 153, 0);">const</span> CompilerInstance &amp;CI,
                       <span style="box-sizing: border-box; color: rgb(133, 153, 0);">const</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">vector</span>&lt;<span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>&gt; &amp;args)</span> override </span>{
            <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box;">true</span>;
        }
};</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">接着，在改写｀MyPluginConsumer｀类前要引用一个叫｀RecursiveASTVisitor｀的类模版。该类型主要作用是前序或后续地深度优先搜索整个AST，并访问每一个节点的基类，主要利用它来遍历一些需要处理的节点。同样，需要创建一个实现｀RecursiveASTVisitor｀的模版类。如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">class MyPluginVisitor : public RecursiveASTVisitor&lt;MobCodeVisitor&gt;
{
<span style="box-sizing: border-box; color: rgb(203, 75, 22);">    private:</span>
        CompilerInstance &amp;<span style="box-sizing: border-box; color: rgb(133, 153, 0);">Instance;
</span>        ASTContext *<span style="box-sizing: border-box; color: rgb(38, 139, 210);">Context</span><span style="box-sizing: border-box; color: rgb(147, 161, 161);">;</span>
<span style="box-sizing: border-box; color: rgb(203, 75, 22);">
    public:</span>

        void setASTContext (ASTContext &amp;<span style="box-sizing: border-box; color: rgb(38, 139, 210);">context</span>)
        {
            this -&gt; <span style="box-sizing: border-box; color: rgb(38, 139, 210);">Context</span> = &amp;<span style="box-sizing: border-box; color: rgb(38, 139, 210);">context</span><span style="box-sizing: border-box; color: rgb(147, 161, 161);">;</span>
        }

        MyPluginVisitor (CompilerInstance &amp;<span style="box-sizing: border-box; color: rgb(133, 153, 0);">Instance)
</span>            :<span style="box-sizing: border-box; color: rgb(133, 153, 0);">Instance(Instance)
</span>        {

        }
}<span style="box-sizing: border-box; color: rgb(147, 161, 161);">;</span></code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">然后在<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">MyPluginConsumer</code>加入<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">MyPluginVisitor</code>模版类的引用，修改如下：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">class</span> MyPluginConsumer : <span style="box-sizing: border-box; color: rgb(133, 153, 0);">public</span> ASTConsumer
{
    CompilerInstance &amp;Instance;
    <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">set</span>&lt;<span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>&gt; ParsedTemplates;
    <span style="box-sizing: border-box; color: rgb(133, 153, 0);">public</span>:
        MyPluginConsumer(CompilerInstance &amp;Instance,
                               <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">set</span>&lt;<span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>&gt; ParsedTemplates)
        : Instance(Instance), ParsedTemplates(ParsedTemplates), visitor(Instance) {}

        <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">bool</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">HandleTopLevelDecl</span><span style="box-sizing: border-box;">(DeclGroupRef DG)</span> override
        </span>{
            <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box;">true</span>;
        }

        <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">void</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">HandleTranslationUnit</span><span style="box-sizing: border-box;">(ASTContext&amp; context)</span> override
        </span>{
            visitor.setASTContext(context);
            visitor.TraverseDecl(context.getTranslationUnitDecl());
        }
    <span style="box-sizing: border-box; color: rgb(133, 153, 0);">private</span>:
        MyPluginVisitor visitor;
};</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">这里要说明的是<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">MyPluginConsumer::HandleTopLevelDecl</code>方法表示每次分析到一个顶层定义时(Top level decl)就会回调到此方法。返回true表示处理该组定义，否则忽略该部分处理。而<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">MyPluginConsumer::HandleTranslationUnit</code>方法则为<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">ASTConsumer</code>的入口函数，当所有单元被解析成AST时会回调该方法。而方法中调用了<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">visitor</code>的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">TraverseDecl</code>方法来对已解析完成AST节点进行遍历。在遍历过程中只要在<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">Visitor</code>类中捕获不同的声明和定义即可对代码进行语法检测。
</p><h2 style="box-sizing: border-box; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); font-size: 24px; text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">8.1 检测ObjC中的类声明
</h2><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">按照一般的类声明规范，类名需要驼峰式的拼写方法，并且类名第一个字母需要大写。如果不符合这个规范则需要在编译过程中提示警告信息。为了实现这样的效果，需要在<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">MyPluginVisitor</code>中加入<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">VisitObjCInterfaceDecl</code>方法来捕获OC的类声明节点。具体代码如下：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">bool</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">VisitObjCInterfaceDecl</span><span style="box-sizing: border-box;">(ObjCInterfaceDecl *declaration)</span>
</span>{
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isUserSourceCode(declaration))
      {
           checkClassNameForLowercaseName(declaration);
           checkClassNameForUnderscoreInName(declaration);
      }

      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box;">true</span>;
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  判断是否为用户源码

  @param decl 声明
  @return true 为用户源码，false 非用户源码
 */</span>
<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">bool</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">isUserSourceCode</span> <span style="box-sizing: border-box;">(Decl *decl)</span>
</span>{
      <span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span> filename = Instance.getSourceManager().getFilename(decl-&gt;getSourceRange().getBegin()).str();

      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (filename.empty())
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box;">false</span>;

      <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//非XCode中的源码都认为是用户源码</span>
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span>(filename.find(<span style="box-sizing: border-box; color: rgb(42, 161, 152);">"/Applications/Xcode.app/"</span>) == <span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>)
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box;">false</span>;

      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box;">true</span>;
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测类名是否存在小写开头

  @param decl 类声明
 */</span>
<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">void</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">checkClassNameForLowercaseName</span><span style="box-sizing: border-box;">(ObjCInterfaceDecl *decl)</span>
</span>{
      StringRef className = decl -&gt; getName();

      <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//类名称必须以大写字母开头</span>
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">char</span> c = className[<span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>];
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isLowercase(c))
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//修正提示</span>
           <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span> tempName = className;
           tempName[<span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>] = toUppercase(c);
           <span style="box-sizing: border-box;">StringRef <span style="box-sizing: border-box; color: rgb(38, 139, 210);">replacement</span><span style="box-sizing: border-box;">(tempName)</span></span>;
           SourceLocation nameStart = decl-&gt;getLocation();
           SourceLocation nameEnd = nameStart.getLocWithOffset(className.size() - <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
           FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement);

           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//报告警告</span>
           DiagnosticsEngine &amp;D = Instance.getDiagnostics();
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> diagID = D.getCustomDiagID(DiagnosticsEngine::Error, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Class name should not start with lowercase letter"</span>);
           SourceLocation location = decl-&gt;getLocation();
           D.Report(location, diagID).AddFixItHint(fixItHint);
       }
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测类名是否包含下划线

  @param decl 类声明
 */</span>
<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">void</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">checkClassNameForUnderscoreInName</span><span style="box-sizing: border-box;">(ObjCInterfaceDecl *decl)</span>
</span>{
      StringRef className = decl -&gt; getName();

      <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//类名不能包含下划线</span>
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">size_t</span> underscorePos = className.find(<span style="box-sizing: border-box; color: rgb(42, 161, 152);">'_'</span>);
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (underscorePos != StringRef::npos)
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//修正提示</span>
           <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span> tempName = className;
           <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>::iterator end_pos = <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::remove(tempName.begin(), tempName.end(), <span style="box-sizing: border-box; color: rgb(42, 161, 152);">'_'</span>);
           tempName.erase(end_pos, tempName.end());
           <span style="box-sizing: border-box;">StringRef <span style="box-sizing: border-box; color: rgb(38, 139, 210);">replacement</span><span style="box-sizing: border-box;">(tempName)</span></span>;
           SourceLocation nameStart = decl-&gt;getLocation();
           SourceLocation nameEnd = nameStart.getLocWithOffset(className.size() - <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
           FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement);

           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//报告错误</span>
           DiagnosticsEngine &amp;diagEngine = Instance.getDiagnostics();
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">unsigned</span> diagID = diagEngine.getCustomDiagID(DiagnosticsEngine::Error, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Class name with `_` forbidden"</span>);
           SourceLocation location = decl-&gt;getLocation().getLocWithOffset(underscorePos);
           diagEngine.Report(location, diagID).AddFixItHint(fixItHint);
       }
}</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">从上面代码可以看到，整个<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">VisitObjCInterfaceDecl</code>方法的处理过程是：先判断是否为自己项目的源码，然后再分别检查类名字是否小写开头和类名称存在下划线，如果有这些情况则报告警告并提供修改建议。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">其中的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">isUserSourceCode</code>方法判断比较重要，如果不实现该判断，则所有经过编译的代码文件中的类型都会被检测，包括系统库中的类型定义。该方法的基本处理思路是通过获取定义（Decl）所在的源码文件路径，通过比对路径来区分哪些是项目引入代码，哪些是系统代码。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkClassNameForLowercaseName</code>和<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkClassNameForUnderscoreInName</code>方法处理逻辑基本相同，通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">decl -&gt; getName()</code>来获取一个指向类名称的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">StringRef</code>对象，然后通过比对类名中的字符来实现相关的检测。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">这里要说明的是关于编译的修正提示和诊断报告的实现，<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">DiagnosticsEngine</code>的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">Report</code>方法可以给Xcode一个编译的诊断报告，这个报告可以是警告（<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">DiagnosticsEngine::Warning</code>）也可以是错误（<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">DiagnosticsEngine::Error</code>），具体的报告类型可根据具体需求决定，但是不同的报告类型会导致不同的处理结果，如果是警告信息则不影响编译，编译工作会继续往下进行，如果是错误则编译工作会被终止。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">首先，需要从编译器实例（<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">CompilerInstance</code>）中取得诊断器（<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">DiagnosticsEngine</code>），由于是一个自定义诊断报告，因此诊断标识需要通过诊断器的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">getCustomDiagID</code>方法取得，方法中需要传入报告类型和报告说明。然后调用诊断器的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">Report</code>方法，把有问题的源码位置和诊断标识传进去。如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">DiagnosticsEngine </span>&amp;<span style="box-sizing: border-box; color: rgb(133, 153, 0);">diagEngine </span>= <span style="box-sizing: border-box; color: rgb(133, 153, 0);">Instance.getDiagnostics();
</span>unsigned <span style="box-sizing: border-box; color: rgb(133, 153, 0);">diagID </span>= <span style="box-sizing: border-box; color: rgb(133, 153, 0);">diagEngine.getCustomDiagID(DiagnosticsEngine::Error, </span><span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Class name with `_` forbidden"</span>)<span style="box-sizing: border-box; color: rgb(147, 161, 161);">;</span>
SourceLocation location = decl-&gt;getLocation().getLocWithOffset(underscorePos)<span style="box-sizing: border-box; color: rgb(147, 161, 161);">;</span>
<span style="box-sizing: border-box; color: rgb(133, 153, 0);">diagEngine.Report(location, </span><span style="box-sizing: border-box; color: rgb(133, 153, 0);">diagID);</span></code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">至于修正提示则是在诊断报告的基础上进行的，其通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">FixItHint</code>对象来包含一个修改提示行为，主要描述了某段源码需要修改成指定的内容。如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement);</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">最后在报告后通过AddFixItHint方法将提示信息附加到报告上，如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box;">diagEngine</span><span style="box-sizing: border-box;">.Report</span>(<span style="box-sizing: border-box;">location</span>, <span style="box-sizing: border-box;">diagID</span>)<span style="box-sizing: border-box;">.AddFixItHint</span>(<span style="box-sizing: border-box;">fixItHint</span>);</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">然后，编译插件，接下来新建一个项目验证一下插件是否正常工作。新建一个类文件ClassDecl，如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(181, 137, 0);">@interface</span> <span style="box-sizing: border-box; color: rgb(181, 137, 0);">class_Decl </span>: NSObject

<span style="box-sizing: border-box; color: rgb(181, 137, 0);">@end</span></code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">编译时就会弹出错误提示，如：
</p><div style="box-sizing: border-box; padding-bottom: 25px; text-align: center; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="%E4%BD%BF%E7%94%A8Xcode%E5%BC%80%E5%8F%91iOS%E8%AF%AD%E6%B3%95%E6%A3%80%E6%9F%A5%E7%9A%84Clang%E6%8F%92%E4%BB%B6.resources/399E509B-660D-44D6-A747-1695CFDC7F88.png" height="216" width="1240"/><br style="box-sizing: border-box;"/><br/><div style="box-sizing: border-box; min-width: 20%; max-width: 80%; min-height: 22px; padding: 10px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150);">检测语法插件演示
</div></div><h2 style="box-sizing: border-box; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); font-size: 24px; text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">8.2 检测ObjC中的方法声明
</h2><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">方法的检测主要包括是方法名称首字母是否为大写，每个参数的名称首字母是否为大写以及每个方法的实现是否超过500行。具体实现如下：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">bool VisitObjCMethodDecl(ObjCMethodDecl *declaration)
{
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isUserSourceCode(declaration))
      {
            checkMethodNameForUppercaseName(declaration);
            checkMethodParamsNameForUppercaseName(declaration);
            checkMethodBodyForOver500Lines(declaration);
      }

      return <span style="box-sizing: border-box;">true</span>;
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测方法名是否存在大写开头

  @param decl 方法声明
 */</span>
void checkMethodNameForUppercaseName(ObjCMethodDecl *decl)
{
      <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//检查名称的每部分，都不允许以大写字母开头</span>
      S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">elector</span> sel = decl -&gt;</span> getSelector();
      <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">int</span> selectorPartCount = decl -&gt;</span> getNumSelectorLocs();
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">for</span> (int i = <span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>; i &lt; selectorPartCount; i++)
      {
           StringRef selName = sel.getNameForSlot(i);
           char c = selName[<span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>];
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isUppercase(c))
           {
               <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//修正提示</span>
               std::string tempName = selName;
               tempName[<span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>] = toLowercase(c);
               StringRef replacement(tempName);
               S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">ourceLocation</span> nameStart = decl -&gt;</span> getSelectorLoc(i);
               SourceLocation nameEnd = nameStart.getLocWithOffset(selName.size() - <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
               FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement);

               <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//报告警告</span>
               DiagnosticsEngine &amp;D = Instance.getDiagnostics();
               int diagID = D.getCustomDiagID(DiagnosticsEngine::Warning, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Selector name should not start with uppercase letter"</span>);
               S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">ourceLocation</span> location = decl-&gt;</span>getLocation();
               D.Report(location, diagID).AddFixItHint(fixItHint);
           }
     }
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测方法中定义的参数名称是否存在大写开头

  @param decl 方法声明
 */</span>
void checkMethodParamsNameForUppercaseName(ObjCMethodDecl *decl)
{
      <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">for</span> (ObjCMethodDecl::param_iterator it = decl -&gt;</span> <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">param_begin</span>(); it != decl -&gt;</span> param_end(); it++)
      {
           ParmVarDecl *parmVarDecl = *it;
           S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">tringRef</span> <span style="box-sizing: border-box; color: rgb(133, 153, 0);">name</span> = parmVarDecl -&gt;</span> getName();
           char c = <span style="box-sizing: border-box; color: rgb(133, 153, 0);">name</span>[<span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>];
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isUppercase(c))
           {
                <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//修正提示</span>
                std::string tempName = <span style="box-sizing: border-box; color: rgb(133, 153, 0);">name</span>;
                tempName[<span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>] = toLowercase(c);
                StringRef replacement(tempName);
                S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">ourceLocation</span> nameStart = parmVarDecl -&gt;</span> getLocation();
                SourceLocation nameEnd = nameStart.getLocWithOffset(<span style="box-sizing: border-box; color: rgb(133, 153, 0);">name</span>.size() - <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
                FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement);

                <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//报告警告</span>
                DiagnosticsEngine &amp;D = Instance.getDiagnostics();
                int diagID = D.getCustomDiagID(DiagnosticsEngine::Warning, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Selector's param name should not start with uppercase letter"</span>);
                S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">ourceLocation</span> location = decl-&gt;</span>getLocation();
                D.Report(location, diagID).AddFixItHint(fixItHint);
            }
        }
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测方法实现是否超过500行代码

  @param decl 方法声明
 */</span>
void checkMethodBodyForOver500Lines(ObjCMethodDecl *decl)
{
      <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">if</span> (decl -&gt;</span> hasBody())
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//存在方法体</span>
           S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">tmt</span> *methodBody = decl -&gt;</span> getBody();

           string srcCode;
           <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">srcCode</span>.assign(Instance.getSourceManager().getCharacterData(methodBody-&gt;</span>getSourceRange().getBegin()),
                          <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">methodBody</span>-&gt;</span><span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">getSourceRange</span>().getEnd().getRawEncoding() - methodBody-&gt;</span>getSourceRange().getBegin().getRawEncoding() + <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
           vector&lt;string&gt; lines = split(srcCode, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">'\n'</span>);
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span>(lines.size() &gt; <span style="box-sizing: border-box; color: rgb(42, 161, 152);">500</span>)
           {
               DiagnosticsEngine &amp;D = Instance.getDiagnostics();
               unsigned diagID = D.getCustomDiagID(DiagnosticsEngine::Warning, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Single method should not have body over 500 lines"</span>);
               D.R<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">eport</span>(decl -&gt;</span> getSourceRange().getBegin(), diagID);
           }
      }
}</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">上述代码中使用<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">VisitObjCMethodDecl</code>方法来处理每个ObjC方法的声明。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkMethodNameForUppercaseName</code>方法主要是检测方法名是否以大写开头，如果存在则发出警告，与类名称的检测处理类似，唯一不同的是ObjC的方法由多个部分组成，如：<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">method:param1Desc:param2Dec:</code>这种形式，因此在检测的时候需要通过声明（decl）的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">getNumSelectorLocs</code>方法取得方法有多少部分，然后通过遍历的形式，对每部分进行检测。<strong style="box-sizing: border-box; font-weight: 700;">要注意的是，声明（decl）是不能直接取到方法每部分的名字的，其需要通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">getSelector</code>方法取得一个<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">Selector</code>对象，然后使用<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">Selector</code>对象来获取每部分的名称</strong>，如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">Selector </span><span style="box-sizing: border-box; color: rgb(133, 153, 0);">sel </span>= decl -&gt; getSelector()<span style="box-sizing: border-box; color: rgb(147, 161, 161);">;</span>
<span style="box-sizing: border-box; color: rgb(133, 153, 0);">StringRef </span><span style="box-sizing: border-box; color: rgb(133, 153, 0);">selName </span>= <span style="box-sizing: border-box; color: rgb(133, 153, 0);">sel.getNameForSlot(i);</span></code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkMethodParamsNameForUppercaseName</code>方法则是对参数进行检测，这里采用遍历声明（decl）中的每个参数声明（parmVarDecl），然后从参数声明中取得其参数名字的方式来实现命名规范的检测，如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">for</span> (ObjCMethodDecl::param_iterator <span style="box-sizing: border-box;">it</span> = decl<span style="box-sizing: border-box;"> -&gt;</span> param_begin(); <span style="box-sizing: border-box;">it</span> != decl<span style="box-sizing: border-box;"> -&gt;</span> param_end(); <span style="box-sizing: border-box;">it</span>++)
{
      ParmVarDecl *parmVarDecl = *<span style="box-sizing: border-box;">it</span>;
      StringRef name = parmVarDecl<span style="box-sizing: border-box;"> -&gt;</span> getName();
      <span style="box-sizing: border-box; color: rgb(42, 161, 152);">//进行名称检测
}</span></code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkMethodBodyForOver500Lines</code>方法是对方法体的实现行数的限制检测，先从声明（decl）中取得方法体对象（methodBody），然后将方法体中的所有字符都读取出来，最后根据换行符来切分计算行数，如果大于500行则发出警告。如：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;">S<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">tmt</span> *methodBody = decl -&gt;</span> getBody();

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">//读取方法体的内容</span>
string srcCode;
<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">srcCode</span>.assign(Instance.getSourceManager().getCharacterData(methodBody-&gt;</span>getSourceRange().getBegin()),
               <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">methodBody</span>-&gt;</span><span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">getSourceRange</span>().getEnd().getRawEncoding() - methodBody-&gt;</span>getSourceRange().getBegin().getRawEncoding() + <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">//根据回车符切分行</span>
vector&lt;string&gt; lines = split(srcCode, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">'\n'</span>);
<span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span>(lines.size() &gt; <span style="box-sizing: border-box; color: rgb(42, 161, 152);">500</span>)
{
      <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//发出警告</span>
}</code></pre><h2 style="box-sizing: border-box; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); font-size: 24px; text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">8.3 检测ObjC中的属性声明
</h2><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">ObjC属性声明检测包括：属性名称是否存在大写开头、是否包含下划线以及委托属性是否使用weak修饰。实现代码如下：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">bool</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">VisitObjCPropertyDecl</span><span style="box-sizing: border-box;">(ObjCPropertyDecl *declaration)</span>
</span>{
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isUserSourceCode(declaration))
      {
           checkPropertyNameForUppercaseName(declaration);
           checkPropertyNameForUnderscoreInName(declaration);
           checkDelegatePropertyForUsageWeak(declaration);
      }

      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span> <span style="box-sizing: border-box;">true</span>;
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测属性名是否存在大写开头

  @param decl 属性声明
*/</span>
<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">void</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">checkPropertyNameForUppercaseName</span><span style="box-sizing: border-box;">(ObjCPropertyDecl *decl)</span>
</span>{
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">bool</span> checkUppercaseNameIndex = <span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>;

      StringRef name = decl -&gt; getName();

      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (name.find(<span style="box-sizing: border-box; color: rgb(42, 161, 152);">'_'</span>) == <span style="box-sizing: border-box; color: rgb(42, 161, 152);">0</span>)
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//表示以下划线开头</span>
           checkUppercaseNameIndex = <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>;
      }

      <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//名称必须以小写字母开头</span>
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">char</span> c = name[checkUppercaseNameIndex];
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isUppercase(c))
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//修正提示</span>
           <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span> tempName = name;
           tempName[checkUppercaseNameIndex] = toLowercase(c);
           <span style="box-sizing: border-box;">StringRef <span style="box-sizing: border-box; color: rgb(38, 139, 210);">replacement</span><span style="box-sizing: border-box;">(tempName)</span></span>;
           SourceLocation nameStart = decl-&gt;getLocation();
           SourceLocation nameEnd = nameStart.getLocWithOffset(name.size() - <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
           FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement);

           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//报告错误</span>
           DiagnosticsEngine &amp;D = Instance.getDiagnostics();
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">int</span> diagID = D.getCustomDiagID(DiagnosticsEngine::Error, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Property name should not start with uppercase letter"</span>);
           SourceLocation location = decl-&gt;getLocation();
           D.Report(location, diagID).AddFixItHint(fixItHint);
       }
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测属性名是否包含下划线

  @param decl 属性声明
 */</span>
<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">void</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">checkPropertyNameForUnderscoreInName</span><span style="box-sizing: border-box;">(ObjCPropertyDecl *decl)</span>
</span>{
      StringRef name = decl -&gt; getName();

      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (name.size() == <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>)
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//不需要检测</span>
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">return</span>;
      }

      <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//类名不能包含下划线</span>
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">size_t</span> underscorePos = name.find(<span style="box-sizing: border-box; color: rgb(42, 161, 152);">'_'</span>, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (underscorePos != StringRef::npos)
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//修正提示</span>
           <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span> tempName = name;
           <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::<span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>::iterator end_pos = <span style="box-sizing: border-box; color: rgb(38, 139, 210);">std</span>::remove(tempName.begin() + <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>, tempName.end(), <span style="box-sizing: border-box; color: rgb(42, 161, 152);">'_'</span>);
           tempName.erase(end_pos, tempName.end());
           <span style="box-sizing: border-box;">StringRef <span style="box-sizing: border-box; color: rgb(38, 139, 210);">replacement</span><span style="box-sizing: border-box;">(tempName)</span></span>;
           SourceLocation nameStart = decl-&gt;getLocation();
           SourceLocation nameEnd = nameStart.getLocWithOffset(name.size() - <span style="box-sizing: border-box; color: rgb(42, 161, 152);">1</span>);
           FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement);

           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//报告错误</span>
           DiagnosticsEngine &amp;diagEngine = Instance.getDiagnostics();
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">unsigned</span> diagID = diagEngine.getCustomDiagID(DiagnosticsEngine::Error, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Property name with `_` forbidden"</span>);
           SourceLocation location = decl-&gt;getLocation().getLocWithOffset(underscorePos);
           diagEngine.Report(location, diagID).AddFixItHint(fixItHint);
      }
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测委托属性是否有使用weak修饰

  @param decl 属性声明
 */</span>
<span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(133, 153, 0);">void</span> <span style="box-sizing: border-box; color: rgb(38, 139, 210);">checkDelegatePropertyForUsageWeak</span> <span style="box-sizing: border-box;">(ObjCPropertyDecl *decl)</span>
</span>{
     QualType type = decl -&gt; getType();
     StringRef typeStr = type.getAsString();

     <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//Delegate</span>
     <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span>(typeStr.find(<span style="box-sizing: border-box; color: rgb(42, 161, 152);">"&lt;"</span>) != <span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>::npos &amp;&amp; typeStr.find(<span style="box-sizing: border-box; color: rgb(42, 161, 152);">"&gt;"</span>) != <span style="box-sizing: border-box; color: rgb(38, 139, 210);">string</span>::npos)
     {
          ObjCPropertyDecl::PropertyAttributeKind attrKind = decl -&gt; getPropertyAttributes();

          <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span>(!(attrKind &amp; ObjCPropertyDecl::OBJC_PR_weak))
          {
               DiagnosticsEngine &amp;diagEngine = Instance.getDiagnostics();
               <span style="box-sizing: border-box; color: rgb(133, 153, 0);">unsigned</span> diagID = diagEngine.getCustomDiagID(DiagnosticsEngine::Warning, <span style="box-sizing: border-box; color: rgb(42, 161, 152);">"Delegate should be declared as weak."</span>);
               diagEngine.Report(decl -&gt; getLocation(), diagID);
          }
     }
}</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">上述代码中使用<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">VisitObjCPropertyDecl</code>方法来处理每个ObjC属性的声明。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkPropertyNameForUppercaseName</code>与类检测中的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkClassNameForLowercaseName</code>方法处理逻辑基本相同，只是一个判断大小写的区别。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkPropertyNameForUnderscoreInName</code>与类检测中的<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkClassNameForUnderscoreInName</code>方法处理一致。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkDelegatePropertyForUsageWeak</code>方法中直接取到属性类型的文本描述，然后判断类型是否声明协议（即两个尖括号定义，<strong style="box-sizing: border-box; font-weight: 700;">注：这里判断是否存在尖括号是会存在误判的情况，因为泛型同样使用尖括号表示</strong>）,最后再判断属性的修饰是否存在weak，如果没有则报告警告。
</p><h2 style="box-sizing: border-box; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); font-size: 24px; text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">8.4 检测常量／变量声明
</h2><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">变量声明检测主要是区别静态变量、常量和变量，并根据不同类型声明进行不同的检测。如下所示：
</p><pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 13px; padding: 15px; word-break: break-word; word-wrap: normal; color: rgb(101, 123, 131); background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: transparent; border-radius: 0px; padding: 0px; white-space: pre; border: none;"><span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  观察变量声明

  @param declaration 声明对象
  @return 返回
 */</span>
bool VisitVarDecl(VarDecl *declaration)
{
      <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (isUserSourceCode(declaration))
      {
           checkVarName(declaration);
      }

      return <span style="box-sizing: border-box;">true</span>;
}

<span style="box-sizing: border-box; color: rgb(147, 161, 161);">/**
  检测变量名称

  @param decl 变量声明
 */</span>
void checkVarName(VarDecl *decl)
{
      <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">if</span> (decl -&gt;</span> isStaticLocal())
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//静态变量</span>
          <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">if</span> (decl -&gt;</span> <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">getType</span>().isConstant(*this -&gt;</span> Context))
          {
               <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//常量</span>
               checkConstantNameForLowercaseName(decl);
          }
          <span style="box-sizing: border-box; color: rgb(133, 153, 0);">else</span>
          {
               <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//非常量</span>
               checkVarNameForUppercaseName(decl);
          }

      }
      <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">else</span> <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (decl -&gt;</span> isLocalVarDecl())
      {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//本地变量</span>
           <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">if</span> (decl -&gt;</span> <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">getType</span>().isConstant(*this -&gt;</span> Context))
           {
               <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//常量</span>
               checkConstantNameForLowercaseName(decl);
           }
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">else</span>
           {
               <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//非常量</span>
               checkVarNameForUppercaseName(decl);
           }
       }
       <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">else</span> <span style="box-sizing: border-box; color: rgb(133, 153, 0);">if</span> (decl -&gt;</span> isFileVarDecl())
       {
           <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//文件定义变量</span>
           <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">if</span> (decl -&gt;</span> <span style="box-sizing: border-box;"><span style="box-sizing: border-box; color: rgb(38, 139, 210);">getType</span>().isConstant(*this -&gt;</span> Context))
           {
                <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//常量</span>
                checkConstantNameForLowercaseName(decl);
           }
           <span style="box-sizing: border-box; color: rgb(133, 153, 0);">else</span>
           {
                <span style="box-sizing: border-box; color: rgb(147, 161, 161);">//非常量</span>
                checkVarNameForUppercaseName(decl);
           }
       }
}</code></pre><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">用<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">VisitVarDec</code>方法来捕获变量和常量的声明。<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">checkVarName</code>方法中分别通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">isStaticLocal</code>、<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">isLocalVarDecl</code>和<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">isFileVarDecl</code>方法来区分变量的作用域，<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">isStaticLocal</code>表示静态变量，<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">isLocalVarDecl</code>表示本地变量和<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">isFileVarDecl</code>表示文件域中的声明。然后再通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(101, 123, 131); background-color: rgb(246, 246, 246); border-radius: 4px; padding: 2px 4px; border: none; white-space: pre-wrap;">decl -&gt; getType().isConstant(*this -&gt; Context)</code>来判断是否为常量，常量就检测是否以大写开头，变量则检测是否以小写开头。
</p><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">至此，已经把一些基本的OC规范检测进行了实现，如果需要定制更多更复杂的检测规则，可以根据自身的需要来进行实现。
</p><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">9. Clang的应用范围讨论
</h1><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Clang的开源和插件化结构让自定义化成为了可能。像上面说的语法规范与代码质量的检测，编译优化以及语言间的翻译等等它都可以实现。对于语言间的翻译最好的例子就是DynamicCocoa，虽然至今还没有开源，但是可以推测其思路是基于AST的文法无关性，来从OC得到的AST分析结果来输出JS文件的定义。这个例子很好地反映了Clang与AST的强大，我们都知道C／C＋＋语言是能够实现源码级别的跨平台，那么，以后会不会存在任何一门语言都能够实现跨平台呢？这个需要大家往后的努力，这里笔者只是抛出了自己的个人观点。
</p><h1 style="box-sizing: border-box; font-size: 26px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: 700; color: rgb(47, 47, 47); text-rendering: optimizeLegibility; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">10. 推荐链接
</h1></div><p style="box-sizing: border-box; word-break: break-word; color: rgb(47, 47, 47); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="http://clang.llvm.org/">http://clang.llvm.org/</a><br style="box-sizing: border-box;"/><br/><a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="http://codemacro.com/2013/02/12/using-clang/">http://codemacro.com/2013/02/12/using-clang/</a><br style="box-sizing: border-box;"/><br/><a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="https://kangwang1988.github.io/">https://kangwang1988.github.io</a><br style="box-sizing: border-box;"/><br/><a style="box-sizing: border-box; background-color: transparent; color: rgb(49, 148, 208); text-decoration: none; cursor: pointer;" target="_blank" href="http://jszhujun2010.farbox.com/tags/LLVM&amp;Clang">http://jszhujun2010.farbox.com/tags/LLVM&amp;Clang</a></p><br/></div><div><br/></div></body></html>